{% extends "base.html" %} 
<!-- load static files -->
{% load static %} 
<!-- block section -->
{% block content %}

<div x-data="ReceiptProvider()" x-init="init()" class="mx-4 mt-4 mb-24">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Add Expense</h1>
    </div>

    <!-- Families quick info / picker -->
    <div class="bg-white rounded-2xl p-4 mb-4">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-semibold text-gray-900">Family</p>
                <p class="text-xs text-gray-600" x-text="selectedFamily ? selectedFamily.name : 'Loading...'"></p>
            </div>
            <div>
                <select
                    x-model.number="form.family_id"
                    class="px-3 py-2 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                >
                    <template x-for="f in families" :key="f.id">
                        <option :value="f.id" x-text="f.name"></option>
                    </template>
                </select>
            </div>
        </div>
    </div>

    <!-- Manual Mode -->
    <div class="bg-white rounded-2xl p-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-4">Enter Details</h3>
        <form @submit.prevent="saveRecord()">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
                    <input
                        type="text"
                        x-model="form.name"
                        name="name"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                        placeholder="e.g. McDonald's"
                    />
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Amount</label>
                    <input
                        type="number"
                        step="0.01"
                        x-model.number="form.amount"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                        required
                    />
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                    <select
                        x-model="form.category"
                        name="category"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                    >
                        <option value="">Select a category</option>
                        <option value="food">Food</option>
                        <option value="transport">Transport</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="shopping">Shopping</option>
                        <option value="other">Other</option>
                        <option value="rent">Rent</option>
                        <option value="utilities">Utilities</option>
                        <option value="insurance">Insurance</option>
                        <option value="education">Education</option>
                        <option value="health">Health</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                <textarea
                    x-model="form.description"
                    rows="3"
                    class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                    placeholder="Optional note"
                ></textarea>
            </div>

            <div class="flex gap-3 mt-6">
                <button type="submit" class="flex-1 px-4 py-3 bg-green-900 text-white rounded-xl font-semibold hover:bg-green-800 transition">
                    Save Record
                </button>
                <button
                    type="button"
                    @click="resetForm()"
                    class="px-4 py-3 border border-gray-200 rounded-xl font-semibold text-gray-700 hover:bg-gray-50 transition"
                >
                    Clear
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    [x-cloak] {
        display: none !important;
    }
</style>

<script>
    window.active_page = "scan";

    // Existing families API from your app
    window.endpoints = {
        families: "{% url 'family_collection_api' %}",
        create: "{% url 'record_collection_api' %}",
    };

    function getCSRFToken() {
        const match = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : "";
    }

    function ReceiptProvider() {
        return {
            families: [],
            selectedFamily: null,
            form: {
                family_id: null,
                name: "",
                amount: null,
                category: "",
                description: "",
            },

            async init() {
                await this.loadFamilies();
            },

            async loadFamilies() {
                const res = await fetch(window.endpoints.families, {
                    method: "GET",
                    headers: { Accept: "application/json" },
                    credentials: "same-origin",
                });
                if (!res.ok) {
                    alert("Failed to load families.");
                    return;
                }
                const data = await res.json();
                this.families = (data.families || []).map((f, idx) => ({ ...f, id: f.id ?? idx + 1 }));
                // If backend serializer doesnâ€™t include id, use index fallback, adjust backend to return id ideally.
                if (this.families.length) {
                    const first = this.families[0];
                    this.form.family_id = first.id;
                    this.selectedFamily = first;
                }
            },

            resetForm() {
                this.form.amount = null;
                this.form.category = "";
                this.form.description = "";
            },

            async saveRecord() {
                if (!this.form.family_id) {
                    alert("Select a family.");
                    return;
                }
                if (!this.form.amount) {
                    alert("Amount is required.");
                    return;
                }

                const res = await fetch(window.endpoints.create, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Accept: "application/json",
                        "X-CSRFToken": getCSRFToken(),
                    },
                    credentials: "same-origin",
                    body: JSON.stringify({
                        name: this.form.name,
                        family_id: this.form.family_id,
                        amount: this.form.amount,
                        category: this.form.category,
                        description: this.form.description,
                    }),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert(err.detail || "Failed to save record.");
                    return;
                }
                this.resetForm();
                alert("Record saved.");
            },
        };
    }
</script>
{% endblock %}
