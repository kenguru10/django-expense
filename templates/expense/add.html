{% extends "base.html" %} 
<!-- load static files -->
{% load static %} 
<!-- block section -->
{% block content %}

<div x-data="ReceiptProvider()" x-init="init()" class="mx-4 mt-4 mb-24">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Add Expense</h1>

        <div class="flex gap-2 bg-gray-100 rounded-xl p-1">
            <button
                @click="mode = 'scan'; startCamera()"
                :class="mode === 'scan' ? 'bg-green-900 text-white' : 'text-gray-700'"
                class="px-3 py-1 rounded-lg font-semibold transition"
            >
                Scan
            </button>
            <button
                @click="mode = 'manual'; stopCamera()"
                :class="mode === 'manual' ? 'bg-green-900 text-white' : 'text-gray-700'"
                class="px-3 py-1 rounded-lg font-semibold transition"
            >
                Manual
            </button>
        </div>
    </div>

    <!-- Families quick info / picker -->
    <div class="bg-white rounded-2xl p-4 mb-4">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-semibold text-gray-900">Family</p>
                <p class="text-xs text-gray-600" x-text="selectedFamily ? selectedFamily.name : 'Loading...'"></p>
            </div>
            <div>
                <select
                    x-model.number="form.family_id"
                    class="px-3 py-2 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                >
                    <template x-for="f in families" :key="f.id">
                        <option :value="f.id" x-text="f.name"></option>
                    </template>
                </select>
            </div>
        </div>
    </div>

    <!-- Scan Mode -->
    <div x-show="mode === 'scan'" class="space-y-4">
        <!-- Camera -->
        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-4">
            <div class="relative rounded-xl overflow-hidden bg-black">
                <video x-ref="video" autoplay playsinline class="w-full h-72 object-cover"></video>
                <canvas x-ref="canvas" class="hidden"></canvas>
            </div>

            <div class="flex gap-3 mt-4">
                <button @click="capture()" class="flex-1 px-4 py-3 bg-green-900 text-white rounded-xl font-semibold hover:bg-green-800 transition">
                    Capture
                </button>
                <button
                    @click="flipCamera()"
                    class="px-4 py-3 border border-gray-200 rounded-xl font-semibold text-gray-700 hover:bg-gray-50 transition"
                >
                    Flip
                </button>
                <button
                    @click="stopCamera()"
                    class="px-4 py-3 border border-gray-200 rounded-xl font-semibold text-gray-700 hover:bg-gray-50 transition"
                >
                    Stop
                </button>
            </div>

            <!-- Preview -->
            <div x-show="imageDataUrl" class="mt-4 bg-white rounded-xl p-4">
                <p class="text-sm font-semibold text-gray-900 mb-2">Preview</p>
                <img :src="imageDataUrl" alt="receipt" class="rounded-xl w-full" />
                <div class="flex gap-3 mt-3">
                    <button
                        @click="scanReceipt()"
                        class="flex-1 px-4 py-3 bg-green-900 text-white rounded-xl font-semibold hover:bg-green-800 transition"
                        :disabled="loading"
                        :class="loading ? 'opacity-50 cursor-not-allowed' : ''"
                    >
                        <span x-text="loading ? 'Scanning...' : 'Scan Receipt'"></span>
                    </button>
                    <button
                        @click="imageDataUrl = ''"
                        class="px-4 py-3 border border-gray-200 rounded-xl font-semibold text-gray-700 hover:bg-gray-50 transition"
                    >
                        Retake
                    </button>
                </div>
            </div>
        </div>

        <!-- Parsed Form -->
        <div class="bg-white rounded-2xl p-6">
            <h3 class="text-sm font-semibold text-gray-900 mb-4">Details</h3>
            <form @submit.prevent="saveRecord()">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
                        <input
                            type="text"
                            x-model="form.name"
                            name="name"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                            placeholder="e.g. McDonald's"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Amount</label>
                        <input
                            type="number"
                            step="0.01"
                            x-model.number="form.amount"
                            name="amount"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                            required
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                        <select
                            x-model="form.category"
                            name="category"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                        >
                            <option value="">Select a category</option>
                            <option value="food">Food</option>
                            <option value="transport">Transport</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="shopping">Shopping</option>
                            <option value="other">Other</option>
                            <option value="rent">Rent</option>
                            <option value="utilities">Utilities</option>
                            <option value="insurance">Insurance</option>
                            <option value="education">Education</option>
                            <option value="health">Health</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                    <textarea
                        x-model="form.description"
                        name="description"
                        rows="3"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                        placeholder="Optional note"
                    ></textarea>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 px-4 py-3 bg-green-900 text-white rounded-xl font-semibold hover:bg-green-800 transition">
                        Save Record
                    </button>
                    <button
                        type="button"
                        @click="resetForm()"
                        class="px-4 py-3 border border-gray-200 rounded-xl font-semibold text-gray-700 hover:bg-gray-50 transition"
                    >
                        Clear
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manual Mode -->
    <div x-show="mode === 'manual'" x-cloak class="bg-white rounded-2xl p-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-4">Enter Details</h3>
        <form @submit.prevent="saveRecord()">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
                    <input
                        type="text"
                        x-model="form.name"
                        name="name"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                        placeholder="e.g. McDonald's"
                    />
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Amount</label>
                    <input
                        type="number"
                        step="0.01"
                        x-model.number="form.amount"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                        required
                    />
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                    <select
                        x-model="form.category"
                        name="category"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                    >
                        <option value="">Select a category</option>
                        <option value="food">Food</option>
                        <option value="transport">Transport</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="shopping">Shopping</option>
                        <option value="other">Other</option>
                        <option value="rent">Rent</option>
                        <option value="utilities">Utilities</option>
                        <option value="insurance">Insurance</option>
                        <option value="education">Education</option>
                        <option value="health">Health</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                <textarea
                    x-model="form.description"
                    rows="3"
                    class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none"
                    placeholder="Optional note"
                ></textarea>
            </div>

            <div class="flex gap-3 mt-6">
                <button type="submit" class="flex-1 px-4 py-3 bg-green-900 text-white rounded-xl font-semibold hover:bg-green-800 transition">
                    Save Record
                </button>
                <button
                    type="button"
                    @click="resetForm()"
                    class="px-4 py-3 border border-gray-200 rounded-xl font-semibold text-gray-700 hover:bg-gray-50 transition"
                >
                    Clear
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    [x-cloak] {
        display: none !important;
    }
</style>

<script>
    window.active_page = "scan";

    // Existing families API from your app
    window.endpoints = {
        families: "{% url 'family_collection_api' %}",

        // Define these URL names in backend:
        // - record_scan_api: POST image -> { amount, category, description }
        // - record_collection_api: POST { family_id, amount, category, description } -> created record
        scan: "{% url 'record_scan_api' %}",
        create: "{% url 'record_collection_api' %}",
    };

    function getCSRFToken() {
        const match = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : "";
    }

    function ReceiptProvider() {
        return {
            mode: "scan",
            stream: null,
            facingMode: "environment",
            imageDataUrl: "",
            loading: false,

            families: [],
            selectedFamily: null,
            form: {
                family_id: null,
                name: "",
                amount: null,
                category: "",
                description: "",
            },

            async init() {
                await this.loadFamilies();
                if (this.mode === "scan") {
                    this.startCamera();
                }
            },

            async loadFamilies() {
                const res = await fetch(window.endpoints.families, {
                    method: "GET",
                    headers: { Accept: "application/json" },
                    credentials: "same-origin",
                });
                if (!res.ok) {
                    alert("Failed to load families.");
                    return;
                }
                const data = await res.json();
                this.families = (data.families || []).map((f, idx) => ({ ...f, id: f.id ?? idx + 1 }));
                // If backend serializer doesn’t include id, use index fallback, adjust backend to return id ideally.
                if (this.families.length) {
                    const first = this.families[0];
                    this.form.family_id = first.id;
                    this.selectedFamily = first;
                }
            },

            async startCamera() {
                try {
                    await this.stopCamera();
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: this.facingMode },
                        audio: false,
                    });
                    this.$refs.video.srcObject = this.stream;
                } catch (e) {
                    alert("Unable to access camera.");
                }
            },

            async stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach((t) => t.stop());
                    this.stream = null;
                }
            },

            flipCamera() {
                this.facingMode = this.facingMode === "environment" ? "user" : "environment";
                this.startCamera();
            },

            capture() {
                const video = this.$refs.video;
                const canvas = this.$refs.canvas;
                const w = video.videoWidth || 1280;
                const h = video.videoHeight || 720;
                canvas.width = w;
                canvas.height = h;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, w, h);
                this.imageDataUrl = canvas.toDataURL("image/jpeg", 0.9);
            },

            async scanReceipt() {
                if (!this.imageDataUrl) return;
                this.loading = true;
                try {
                    const res = await fetch(window.endpoints.scan, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Accept: "application/json",
                            "X-CSRFToken": getCSRFToken(),
                        },
                        credentials: "same-origin",
                        body: JSON.stringify({ image: this.imageDataUrl }),
                    });
                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        alert(err.detail || "Failed to scan receipt.");
                        return;
                    }
                    const parsed = await res.json();
                    this.form.amount = parsed.amount ?? this.form.amount;
                    this.form.category = parsed.category ?? this.form.category;
                    this.form.description = parsed.description ?? this.form.description;
                } finally {
                    this.loading = false;
                }
            },

            resetForm() {
                this.form.amount = null;
                this.form.category = "";
                this.form.description = "";
                this.imageDataUrl = "";
            },

            async saveRecord() {
                if (!this.form.family_id) {
                    alert("Select a family.");
                    return;
                }
                if (!this.form.amount) {
                    alert("Amount is required.");
                    return;
                }

                const res = await fetch(window.endpoints.create, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Accept: "application/json",
                        "X-CSRFToken": getCSRFToken(),
                    },
                    credentials: "same-origin",
                    body: JSON.stringify({
                        name: this.form.name,
                        family_id: this.form.family_id,
                        amount: this.form.amount,
                        category: this.form.category,
                        description: this.form.description,
                    }),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert(err.detail || "Failed to save record.");
                    return;
                }
                this.resetForm();
                alert("Record saved.");
            },
        };
    }
</script>
{% endblock %}
