<!-- base template -->
{% extends "base.html" %}
<!-- load static files -->
{% load static %}

<!-- block section -->
{% block content %}

<!-- Balance Card -->
<div x-data="HomeProvider()" x-init="init()">
    <div x-show="family.have === false" class="relative">
        <div class="text-center mt-10">
            <p class="text-gray-700 mb-4">You have not joined a family yet.</p>
            <button @click="window.location.href='{% url 'family' %}'" class="bg-green-900 text-white rounded-full py-2 px-4 font-medium">Create / Join Family</button>
        </div>
    </div>
    <div x-show="family.have === true" class="relative">
        <div class="mx-4 mt-4 bg-gradient-to-br from-green-100 to-green-200 rounded-3xl p-6 relative">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-700">Your Balance</span>
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                        />
                    </svg>
                </div>
                <button>
                    <svg class="w-6 h-6 text-gray-700" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"
                        />
                    </svg>
                </button>
            </div>
            <h1
                class="text-4xl font-bold text-gray-900 mb-6"
                x-text="`$${(family.max_budget - summary.total_amount_this_month).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} `"
            ></h1>
            <div class="flex justify-between mb-6">
                <div>
                    <p class="text-xs text-gray-600 mb-1">Account Number</p>
                    <p class="text-sm font-semibold text-gray-800" x-text="`**** **** **** ${account.pid.slice(-4)}`"></p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-600 mb-1">Expired Date</p>
                    <p class="text-sm font-semibold text-gray-800" x-text="account.expired_at.toLocaleDateString()"></p>
                </div>
            </div>
            <div class="flex gap-3">
                <button class="flex-1 bg-green-900 text-white rounded-full py-3 px-6 flex items-center justify-center gap-2 font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                    Send
                </button>
                <button class="flex-1 bg-green-400 text-green-900 rounded-full py-3 px-6 flex items-center justify-center gap-2 font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Request
                </button>
                <button class="bg-green-900 text-white rounded-full w-14 h-14 flex items-center justify-center">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M4 4h7v7H4V4zm0 9h7v7H4v-7zm9-9h7v7h-7V4zm0 9h7v7h-7v-7z" />
                    </svg>
                </button>
            </div>
        </div>
        <!-- Overview Section -->
        <div class="mx-4 mt-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900">Overview</h2>
                <button class="text-sm text-gray-600">Weekly</button>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- Income Card -->
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-4">
                    <div class="bg-green-900 w-10 h-10 rounded-full flex items-center justify-center mb-3">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                        </svg>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">Max Budget</p>
                    <p
                        class="text-xl font-bold text-gray-900"
                        x-text="`$${family.max_budget.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} `"
                    ></p>
                </div>
                <!-- Spending Card -->
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-4">
                    <div class="bg-green-900 w-10 h-10 rounded-full flex items-center justify-center mb-3">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18" />
                        </svg>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">Spending</p>
                    <p
                        class="text-xl font-bold text-gray-900"
                        x-text="`-$${summary.total_amount_this_month.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} `"
                    ></p>
                </div>
            </div>
            <!-- Chart Section -->
            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-4 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-semibold text-gray-900">Overview Spending</h3>
                    <button class="text-xs text-gray-600">More Details</button>
                </div>
                <div class="flex items-center justify-center h-40">
                    <!-- Placeholder for chart -->
                    <canvas id="memberSpendingChart" width="350" height="140"></canvas>
                </div>
            </div>

            <!-- QR Codes Section -->
            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-4 mb-20">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-semibold text-gray-900">Payment QR Codes</h3>
                </div>

                <form action="{% url 'qrcode_upload' %}" method="post" enctype="multipart/form-data" class="mb-4 space-y-3">
                    {% csrf_token %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Upload QR Code Images</label>
                        <input
                            type="file"
                            name="qrcodes"
                            accept="image/*"
                            multiple
                            class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-green-50 focus:outline-none focus:ring-2 focus:ring-green-200 focus:border-green-500 p-3"
                        />
                        <p class="mt-1 text-xs text-gray-500">You can select and upload multiple QR code images.</p>
                    </div>
                    <button
                        type="submit"
                        class="inline-flex items-center px-4 py-2 bg-green-900 text-white text-sm font-semibold rounded-full hover:bg-green-800 transition"
                    >
                        Upload
                    </button>
                </form>

                <div class="mt-2">
                    {% if qrcodes %}
                        <div class="grid grid-cols-3 gap-4">
                            {% for qr in qrcodes %}
                                <div class="bg-gray-50 rounded-xl p-3 flex flex-col items-center">
                                    <img src="{{ qr.image.url }}" alt="QR Code" class="w-24 h-24 object-contain" />
                                    <p class="mt-2 text-[10px] text-gray-500">{{ qr.created_at|date:"Y-m-d H:i" }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-sm text-gray-500">No QR codes uploaded yet. Use the form above to add one.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end the block -->

<script>
    window.active_page = 'home';

    function HomeProvider() {
        return {
            family: {
                have: {{ family|yesno:"true,false" }},
                max_budget: {{ family.max_budget | default:0 }},
                currency: '{{ family.currency | default:"HKD" }}',
            },
            account: {
                pid: "{{ account.pid }}",
                expired_at: new Date("{{ account.expired_at|date:'c' }}"),
            },
            summary: {
                total_amount_this_month: {{ summary.total_amount_this_month | default:0 }},
            },
            init() {
                // Chart rendering
                const ctx = document.getElementById('memberSpendingChart').getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: {{ chart_labels|safe }},
                        datasets: [{
                            label: 'Spending',
                            data: {{ chart_data|safe }},
                            backgroundColor: 'rgba(34,197,94,0.6)',
                            borderColor: 'rgba(34,197,94,1)',
                            borderWidth: 1,
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '{{ family.currency|default:"HKD" }} ' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            },
        };
    }
</script>
{% endblock %}
